/* === Sidenote layout variables === */
.markdown-source-view.mod-cm6 {
	/* 
	 * Sidenote width uses --sidenote-scale (0 to 1) set by plugin
	 * This creates smooth scaling based on actual editor width
	 */
	--sidenote-base-width: 10rem;
	--sidenote-max-extra: 18rem;

	/* Width scales smoothly from 10rem to 28rem based on editor width */
	--sidenote-width: calc(
		var(--sidenote-base-width) +
			(var(--sidenote-max-extra) * var(--sidenote-scale, 0.5))
	);

	--sidenote-gap: 1.5rem;
	--page-offset: calc(var(--sidenote-width) + var(--sidenote-gap) + 0.5rem);
}

/* Mode-specific overrides */
.markdown-source-view.mod-cm6[data-sidenote-mode="compact"] {
	--sidenote-base-width: 8rem;
	--sidenote-max-extra: 4rem;
	--sidenote-gap: 1rem;
}

.markdown-source-view.mod-cm6[data-sidenote-mode="full"] {
	--sidenote-base-width: 14rem;
	--sidenote-max-extra: 20rem;
	--sidenote-gap: 2rem;
}

/* Allow margin overflow but keep vertical scrolling */
.markdown-source-view.mod-cm6 .cm-scroller {
	overflow-y: auto !important;
	overflow-x: visible !important;
}

/* Apply page offset based on mode (not media query) */
.markdown-source-view.mod-cm6[data-sidenote-mode="compact"]:has(
		.sidenote-margin
	)
	.cm-scroller,
.markdown-source-view.mod-cm6[data-sidenote-mode="normal"]:has(.sidenote-margin)
	.cm-scroller,
.markdown-source-view.mod-cm6[data-sidenote-mode="full"]:has(.sidenote-margin)
	.cm-scroller {
	padding-left: var(--page-offset) !important;
}

/* Prevent clipping by CM layers */
.markdown-source-view.mod-cm6 .cm-editor,
.markdown-source-view.mod-cm6 .cm-content,
.markdown-source-view.mod-cm6 .cm-sizer,
.markdown-source-view.mod-cm6 .cm-contentContainer {
	overflow: visible !important;
}

/* Each line is the positioning context */
.markdown-source-view.mod-cm6 .cm-line {
	position: relative;
}

/* Superscript number in the main text */
.sidenote-number::after {
	content: attr(data-sidenote-num);
	vertical-align: super;
	font-size: 0.7em;
	font-weight: bold;
	margin-right: 0.4rem;
}

/* Hide the original span content */
.sidenote-number > span.sidenote {
	display: inline-block;
	width: 0;
	max-width: 0;
	overflow: hidden;
	white-space: nowrap;
	vertical-align: baseline;
}

/* Sidenote block in the left margin */
.sidenote-margin {
	position: absolute;
	top: 0.2em;
	left: calc(-1 * (var(--sidenote-width) + var(--sidenote-gap)));
	width: var(--sidenote-width);
	font-size: 80%;
	line-height: 1.35;
	text-align: right;
	overflow-wrap: break-word;
	transform: translateY(var(--sidenote-shift, 0px));
	will-change: transform;
	z-index: 10;
	pointer-events: auto;

	/* Smooth width transitions */
	transition:
		width 0.15s ease-out,
		left 0.15s ease-out,
		opacity 0.15s ease-out;
}

/* Compact mode: smaller font, tighter spacing */
.markdown-source-view.mod-cm6[data-sidenote-mode="compact"] .sidenote-margin {
	font-size: 70%;
	line-height: 1.25;
}

/* Number prefix inside the sidenote */
.sidenote-margin[data-sidenote-num]::before {
	content: attr(data-sidenote-num) ". ";
	font-weight: bold;
}

/* Hide sidenotes when mode is hidden */
.markdown-source-view.mod-cm6[data-sidenote-mode="hidden"] .sidenote-margin {
	display: none;
}

/* Also hide with opacity for smoother transitions when near threshold */
.markdown-source-view.mod-cm6[data-sidenote-mode=""] .sidenote-margin {
	opacity: 0;
	pointer-events: none;
}
